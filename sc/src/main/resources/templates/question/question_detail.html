<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
	layout:decorate="~{layout}">

	<th:block layout:fragment="content">

<div class="wrapper">
		<div class="mypage_wrap">
			<div class="container-fluid">

		<div class="card shadow mb-4">
			<div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
				<h5 class="m-0 font-weight-bold text-primary" th:text="${question.title}">제목</h5>
				<div>
					<button th:if="${question.result == false}" 
							th:data-question-id="${question.id}"
							onclick="confirmResolve(this)"
							class="btn btn-primary btn-sm">
						<i class="fas fa-check fa-sm"></i> 해결완료
					</button>
					<span th:if="${question.result == true}" class="btn btn-success btn-circle btn-sm">
						<i class="fa-solid fa-check"></i>
					</span>
				</div>
			</div>
			<div class="card-body">
				<p class="mb-0 text-gray-800" th:text="${question.content}">내용</p>
			</div>
			<div class="card-footer">
				<small class="text-muted" th:text="${'작성일: ' + #temporals.format(question.createDate, 'yyyy-MM-dd HH:mm:ss')}">생성일</small>
				<small class="text-muted ms-2" th:if="${question.modifyDate != null}" th:text="'수정일: ' + ${#temporals.format(question.modifyDate, 'yyyy-MM-dd')}"></small>
			</div>
		</div>
		
		<div>
			<a th:href="@{|/question/modify/${question.id}|}"
				class="btn btn-sm btn-outline-secondary"
				sec:authorize="isAuthenticated()"
				th:if="${question.author != null and #authentication.getPrincipal().getName() == question.author.getName}"
				th:text="수정"></a>
		</div>
		
		<div class="card shadow mb-4">
			<div class="card-header py-3">
				<h5 class="m-0 font-weight-bold text-primary" th:text="'답변 ' + |${#lists.size(answerList)}|"></h5>
			</div>
			<div class="card-body">
				<ul class="list-unstyled">
					<li th:each="answer : ${answerList}" class="mb-3 pb-3 border-bottom">
						<div class="d-flex justify-content-between align-items-center mb-2">
							<strong th:text="${answer.author.name}" class="text-primary"></strong>
							<small class="text-muted" th:text="${#temporals.format(answer.createDate, 'yyyy-MM-dd HH:mm')}"></small>
						</div>
						<form th:action="@{|/answer/modify/${answer.id}|}" method="post" th:if="${#authentication.name == answer.author.name}" class="mb-2">
							<div class="input-group">
								<input name="content" class="form-control answerInput" th:value="${answer.content}" readonly>
								<div class="input-group-append">
									<button th:attr="data-id=${answer.id}" class="btn btn-outline-secondary mod_btn" type="button"><i class="fa-regular fa-pen-to-square"></i></button>
									<button th:attr="data-id=${answer.id}" class="btn btn-outline-primary" type="submit">수정</button>
									<a th:href="@{|/answer/delete/${answer.id}|}" class="btn btn-outline-danger"><i class="fa-solid fa-xmark"></i></a>
								</div>
							</div>
						</form>
						<p th:unless="${#authentication.name == answer.author.name}" th:text="${answer.content}"></p>
					</li>
				</ul>
				<p th:if="${#lists.isEmpty(answerList)}" class="text-center text-muted">
					답변이 없습니다. 답변을 달아주세요.
				</p>
			</div>
		</div>
		
		<div class="card shadow mb-4" sec:authorize="isAuthenticated()">
			<div class="card-header py-3">
				<h5 class="m-0 font-weight-bold text-primary">답변 작성</h5>
			</div>
			<div class="card-body">
				<form th:action="@{|/answer/create/${question.id}|}" th:object="${answerCreateForm}" method="post">
					<div class="alert alert-danger" role="alert" th:if="${#fields.hasAnyErrors()}">
						<div th:each="err : ${#fields.allErrors()}" th:text="${err}"></div>
					</div>
					<div class="form-group">
						<textarea th:field="*{content}" class="form-control" rows="5"></textarea>
					</div>
					<button type="submit" class="btn btn-primary">답변 등록</button>
				</form>
			</div>
		</div>
		
		<div class="d-flex justify-content-between mt-3">
			<a th:href="@{|/question/delete/${question.id}|}"
				class="btn btn-outline-danger"
				sec:authorize="isAuthenticated()"
				th:if="${question.author != null and #authentication.getPrincipal().getName() == question.author.getName}"
				th:text="삭제">삭제
			</a>
			<button type="button" class="btn btn-secondary" onclick="location.href='/question/list'">목록으로</button>
		</div>

		</div>

	</div>
</div>
	<script>
		$(document).ready(function() {
			$('.mod_btn').click(function() { 
				let input = $(this).parent().find('.answerInput');
				if(input.prop("readonly")) {
					input.prop("readonly", false);
					input.css("border", "1px solid black");
				} else {
					input.prop("readonly", true);
					input.css("border", "none");
				}
			});
		});

		function confirmResolve(button) {
		    var questionId = button.getAttribute('data-question-id');
		    if (confirm("해결이 완료되셨나요?")) {
		        window.location.href = '/question/resolve/' + questionId;
		    }
		}
		
	</script>
	</th:block>
</html>