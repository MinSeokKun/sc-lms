<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      layout:decorate="~{layout}">
<th:block layout:fragment="content">
	<style>
		.input_box label { display: inline-block; width: 130px; }
	</style>
	<div id="content" style="height: calc(100vh - 80px);">
		<div class="wrapper">
			<div style="display: flex; flex-direction: column; justify-content: center; align-items: center; margin-top: 10px;">
				<h2 style="margin-bottom: 40px;">개인정보수정</h2>
				<form id="modifyForm" th:action="@{/user/modify}" method="post" enctype="multipart/form-data">
				    <input type="hidden" name="id" th:value="${user.id}" />
				    
				    <!-- 기존 필드들 -->
				    <div class="input_box">
				        <label>이름</label>
				        <input type="text" name="name" th:value="${user.name}" />
				    </div>
				    <div class="input_box">
				        <label>이메일</label>
				        <input type="email" name="email" th:value="${user.email}" readonly="readonly" style="border: none;" />
				    </div>
				    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
					<div class="input_box">
					    <label>현재 비밀번호</label>
					    <input type="password" name="currentPassword" id="currentPassword" required />
					</div>
					<div class="input_box">
					    <label>새 비밀번호</label>
					    <input type="password" name="newPassword" id="newPassword" />
					</div>
					<div class="input_box">
					    <label>새 비밀번호 확인</label>
					    <input type="password" id="newPasswordConfirm" />
					</div>
				    <div class="input_box">
				        <label>전화번호</label>
				        <input type="text" name="tellNumber" th:value="${user.tellNumber}" />
				        <p style="text-align: right;">-를 빼고 입력해주세요.</p>
				    </div>
				    
				    <!-- 프로필 이미지 업로드 필드 추가 -->
				    <div class="input_box">
				        <label>프로필 이미지</label>
				        <input type="file" name="profileImage" accept="image/*" />
				    </div>
				    
				    <!-- 현재 프로필 이미지 표시 (있는 경우) -->
				    <div class="input_box" th:if="${user.profileImage != null}">
				        <label>현재 프로필 이미지</label>
				        <img th:src="${user.profileImage}" alt="현재 프로필 이미지" style="width: 100px; height: 100px;" />
				    </div>
				    
				    <div>
				        <button class="login-btn" type="submit" style="margin-top: 40px">수정</button>
				    </div>
				</form>
			</div>
		</div>
	</div>
<script>

	document.getElementById('modifyForm').addEventListener('submit', function(e) {
	    e.preventDefault(); // 폼 제출을 막습니다.
	    console.log('Form submission event triggered');
	
	    var currentPassword = document.getElementById('currentPassword').value;
	    var newPassword = document.getElementById('newPassword').value;
	    var newPasswordConfirm = document.getElementById('newPasswordConfirm').value;
	
	    if (newPassword !== newPasswordConfirm) {
	        alert('새 비밀번호가 일치하지 않습니다.');
	        return;
	    }
	
	    console.log('Sending fetch request to check password');
	    
	    var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	    var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

	    fetch('/user/checkPassword', {
	        method: 'POST',
	        body: JSON.stringify({ password: currentPassword }),
	        headers: {
	            'Content-Type': 'application/json',
	            [csrfHeader]: csrfToken
	        }
	    })
	    .then(response => response.json())
	    .then(data => {
	        console.log('Password check response:', data);
	        if (data.passwordCorrect) {
	            alert('개인정보가 수정되었습니다.');
	            this.submit(); // 비밀번호가 맞으면 폼을 제출합니다.
	        } else {
	            alert('현재 비밀번호가 일치하지 않습니다.');
	        }
	    })
	    .catch(error => {
	        console.error('Error:', error);
	        alert('오류가 발생했습니다. 다시 시도해 주세요.');
	    });
	});
</script>
</th:block>
</html>