<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      layout:decorate="~{layout}">
<th:block layout:fragment="content">
	<div id="header2" style="display: flex;">
	    <div>
	        <button>강의 대시보드</button>
	    </div>
	    <div>
	        <p>[[${video.title}]]</p>
	    </div>
	    <div>
	        <button>학습알림</button>
	    </div>
	</div>
	<div id="wrap">
	    <div id="content" style="display: flex;">
			<div>
				<iframe width="1280" height="720" 
					th:src="@{|https://www.youtube.com/embed/${video.url}}" 
					th:title="${video.title}" 
					frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
					referrerpolicy="strict-origin-when-cross-origin" 
					allowfullscreen>
				</iframe>
			</div>
			<div id="nav2">
			    <div>
			        <div>
			        	<button>커리큘럼</button>
			        </div>
			        <div>
			        	<button>커뮤니티</button>
		        	</div>
			        <div>
			            <button id="noteLink">강의노트</button>
			        </div>
			    </div>
			
			    <div style="display: none;" class="tab">
			        <div>
			            <!-- 노트 리스트 창 열기 -->
			            <ul>
			                <li th:each="note : ${noteList}">
			                    <div>
			                        <p th:text="${note.content}"></p>
			                        <span th:text="${note.videoTime}"></span>
			                        <button>수정</button>
			                        <button>삭제</button>
			                    </div>
			                </li>
			            </ul>
			        </div>
			        <div>
		        		<div id="editor"></div>
    					<button id="saveButton">저장</button>
			        </div>
			    </div>
			</div>

	    </div>
	</div>
	<script src="https://www.youtube.com/iframe_api"></script>
	
	<script>
        // 전역 변수로 player 선언
        let player;
        let isPlayerReady = false;

        // YouTube IFrame Player API 준비
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('videoIframe', {
                events: {
                    'onReady': onPlayerReady
                }
            });
        }

        function onPlayerReady(event) {
            isPlayerReady = true;
            console.log('YouTube Player Ready');
        }

        $(document).ready(function() {
            let noteLink = $('#noteLink');
            let tab = $('.tab');

            // 노트 클릭 시 노트 리스트와 등록 폼 열기        
            noteLink.click(function(e) {
                e.preventDefault();
                tab.toggle();
            });

            // Toast UI Editor 초기화
            const editor = new toastui.Editor({
                el: document.querySelector('#editor'),
                height: '500px',
                initialEditType: 'markdown',
                previewStyle: 'tab',
            });

            document.getElementById('saveButton').addEventListener('click', async function() {
                const content = editor.getMarkdown(); // 수정된 부분
//                 const videoId = [[${video.id}]]; 

                try {
                    const response = await fetch(`/note/create/${videoId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content: content })
                    });

                    if (!response.ok) {
                        throw new Error('네트워크 응답이 성공하지 않았습니다.');
                    }

                    const newNote = await response.json();
                    addNoteToDOM(newNote);
                    document.getElementById('noteContent').value = ''; // 입력 필드 초기화

                } catch (error) {
                    console.error('노트 작성 실패:', error);
                }
            });

            function addNoteToDOM(note) {
                const notesContainer = document.getElementById('notesContainer');
                const noteElement = document.createElement('div');
                noteElement.textContent = note.content; // 노트 내용을 표시
                notesContainer.appendChild(noteElement);
            }
        });
    </script>

</th:block>
</html>