<html lang="ko" xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
    layout:decorate="~{layout}">
    
    
<th:block layout:fragment="content">

	<div id="header2" style="display: flex;">
	    <div>
	        <button>강의 대시보드</button>
	    </div>
	    <div>
	        <p>[[${video.title}]]</p>
	    </div>
	    <div>
	        <button>학습알림</button>
	    </div>
	</div>
	<div id="wrap">
	    <div id="content" style="display: flex;">
			<div>
<!-- 				<iframe id="videoIframe" width="1280" height="720"  -->
<!-- 					th:src="@{|https://www.youtube.com/embed/${video.url}|}"  -->
<!-- 					th:title="${video.title}"  -->
<!-- 					frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" -->
<!-- 					referrerpolicy="strict-origin-when-cross-origin"  -->
<!-- 					allowfullscreen> -->
<!-- 				</iframe> -->
				<div id="player" class="url-link" th:data-url="${video.url}"></div>
				<div id="playerTime" th:data-time="${videoTime ?: 0}"></div>

			</div>
			<div id="nav2">
			    <div>
			        <div>
			        	<button>커리큘럼</button>
			        </div>
			        <div>
			        	<button>커뮤니티</button>
		        	</div>
			        <div>
			            <button id="noteLink">강의노트</button>
			        </div>
			    </div>
			
			    <div style="display: none;" class="tab">
			        <div>
			        	<button>전체 노트 보기</button>
			            <!-- 노트 리스트 창 열기 -->
			            <ul id="notesContainer">
			                <li th:each="note : ${noteList}">
			                    <div>
			                        <p th:text="${note.content}"></p>
			                        <button class="noteVideoTime"><span th:text="${note.videoTime}"></span></button>
			                    </div>
			                </li>
			            </ul>
			        </div>
			        <div>
		        		<div id="editor"></div>
                        <input id="videoId" hidden="hidden" th:value="${video.id}">
    					<button id="saveButton">저장</button>
			        </div>
			    </div>
			</div>

	    </div>
	</div>
	
	<script layout:fragment="script" type="text/javascript">

		let player;
	
		const playerElement = document.getElementById('player');
		const videoUrl = playerElement.dataset.url;
		
		const playerTimeElement = document.getElementById('playerTime');
		const videoTime = playerElement.dataset.time;
        // YouTube IFrame API 준비 완료 시 호출되는 함수
        function onYouTubeIframeAPIReady() {
			
            player = new YT.Player('player', {
                height: '390',
                width: '640',
                videoId: videoUrl, // 예제 비디오 ID
                playerVars: {
                    'autoplay': 1, // 자동재생 설정
                    'start': videoTime // 영상 10초부터 시작
                },
                events: {
                    'onReady': onPlayerReady
                }
            });
        }
        
        onYouTubeIframeAPIReady();
        
		// 플레이어 준비 완료 시 호출되는 함수
		function onPlayerReady(event) {
			console.log("Player is ready");
		// 플레이어가 준비되었을 때 할 작업을 여기에 추가
        }		
	     
		$(document).ready(function() {

			const noteVideo = $('.noteVideoTime');
		    noteVideo.click(function(e){
				const videoTime = parseFloat($(this).find('span').text());
				player.seekTo(videoTime, true);
			})
			
			
		    const noteLink = $('#noteLink');
		    const tab = $('.tab');
	
		    // 노트 클릭 시 노트 리스트와 등록 폼 열기        
		    noteLink.click(function(e) {
				console.log(videoUrl);
		        e.preventDefault();
		        tab.toggle();
		    });
	
		    // Toast UI Editor 초기화
		    const editor = new toastui.Editor({
		        el: document.querySelector('#editor'),
		        height: '500px',
		        initialEditType: 'markdown',
		        previewStyle: 'tab'
		    });
	
		    // 노트 저장 버튼 클릭 시
		    $('#saveButton').on('click', function() {
		        const content = editor.getMarkdown();
		        const videoId = $('#videoId').val();
		        
		        const videoTime = player ? player.getCurrentTime() : 0;
				console.log(player);
				console.log(videoTime);
				console.log('1234');
				
		        // 노트가 생성될 DOM 요소를 미리 준비
		        const noteElement = createNoteElement('저장 중...', '');
		        $('#notesContainer').append(noteElement);
	
		        // 노트를 서버에 저장
		        saveNoteToServer(videoId, content, videoTime, noteElement, editor);
		    	});
		    
		    
		    // 노트 삭제 버튼 클릭 시
		    $(document).on('click', '.delete-link', handleNoteDelete);
		});
	
		// 새로운 노트 DOM 요소 생성 함수
		function createNoteElement(content, videoTime) {
		    return $('<li>').html(`
		        <div>
		            <p>${content}</p>
		            <span>${videoTime}</span>
		        </div>
		    `);
		}
	
		// 서버에 노트 저장 함수
		function saveNoteToServer(videoId, content, videoTime, noteElement, editor) {
		    $.ajax({
		        url: `/note/create/${videoId}`,
		        method: 'POST',
		        contentType: 'application/json',
		        data: JSON.stringify({ content: content, videoTime: videoTime }),
		        success: function(newNote) {
		            updateNoteElement(noteElement, newNote);
		            editor.setMarkdown(''); // 입력 필드 초기화
		        },
		        error: function(xhr, status, error) {
		            noteElement.find('p').text('노트 작성 실패');
		            console.error('노트 작성 실패:', error);
		        }
		    });
		}
	
		// 노트 DOM 요소 업데이트 함수
		function updateNoteElement(noteElement, note) {
		    noteElement.find('p').text(note.content);
		    noteElement.find('span').text(note.videoTime || ''); // 비디오 시간이 없을 경우 빈 문자열로 처리
		    noteElement.attr('data-note-id', note.id);
		    noteElement.find('.delete-link').attr('data-note-id', note.id);
		}
	
	
		// 기존 노트를 DOM에 추가하는 함수
		function addNoteToDOM(note) {
		    const noteElement = createNoteElement(note.content, note.videoTime);
		    noteElement.attr('data-note-id', note.id);
		    noteElement.find('.delete-link').attr('data-note-id', note.id);
		    $('#notesContainer').append(noteElement);
		}

	</script>

</th:block>
</html>
